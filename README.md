# mandatendatabank-consumer

Consumer service to sync mandatendatabank data from external sources based on diff files generated by [loket-mandatarissen-producer](http://github.com/lblod/loket-mandatarissen-producer). At regular intervals the consumer checks for new diff files and ingests the data found in the files.

The service is based on a PoC application which can be found [here](http://github.com/redpencilio/app-poc-diff).

## Tutorials

### Installation
Add the service to your `docker-compose.yml`:

```
  mandatendatabank-consumer:
    image: lblod/mandatendatabank-consumer
    environment:
      SYNC_BASE_URL: 'https://api.loket.lblod.info # replace with link to Loket API
```

## Reference
### Configuration
The following environment variables can be configured:
* `INGEST_INTERVAL (in ms, default: 5000)`: interval at which the consumer needs to sync data
* `SYNC_BASE_URL`: base URL of the stack hosting the producer API
* `SYNC_FILES_PATH (default: /sync/mandatarissen/files)`: relative path to the endpoint to retrieve names of the diff files from
* `DOWNLOAD_FILES_PATH (default: /files/:id/download)`: relative path to the endpoint to download a diff file from. `:id` will be replaced with the uuid of the file.
* `MU_APPLICATION_GRAPH (default: http://mu.semte.ch/application)`: graph in which all data will be ingested

### Data flow
At regular intervals, the service will execute the following steps:

1. Query the producer service for all diff files since a specific timestamp
2. Download each diff file
3. Ingest each diff file in the `MU_APPLICATION_GRAPH`

## Known limitations
* No batching during ingest. May reach the limitation of number of triples to be inserted/deleted in 1 query.
